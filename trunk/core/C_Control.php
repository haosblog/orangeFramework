<?php/** * File: C_Control.php * Functionality: Basic Controller * Author: Nic XIE * Date: 2012-2-28 * Remark: * ---------------- DO NOT MODIFY THIS FILE UNLESS YOU FULLY UNDERSTAND ! ------------------ */abstract class C_Control {	private static $obj;	/**	 * indexURL is used to redirect to home action	 */	protected $indexURL = '';	/**	 * By default, smarty cache is enabeld when in PRODUCTION mode !	 * But If you want to disable it, for example, member center etc ...	 * pls add '$this->caching = FALSE' in the constructor of your business controller !	 */	protected $caching = true;	/**	 * By default, the template path of smarty is set in CONFIG_PATH / Smarty_config.php	 * But if your view is not under the path, set $viewPath	 */	protected $viewPath = '';	/**	 * Load model	 * <br />After loading a model, the new instance will be added into $obj immediately,	 * <br />which is used to make sure that the same model is only loaded once per page !	 *	 * @param string => model to be loaded	 * @return new instance of $model or raiseError on failure !	 */	public static function load($model) {		return Helper::loadModel($model);	}	/**	 * Redirect to home index action	 *	 * @param boolean => halt script if true	 * @return null	 */	public function goHome($die = TRUE) {		jsRedirect($this->indexURL);		if($die){			die;		}	}	// Set or get property in componment	public function set($name, $value){		$this->$name = $value;	}	public function get($name){		return $this->$name;	}	/**	 * Show message | error on template	 * 	 * @param string $msg => message to display	 * @param string $tpl => template 	 */	public function showMsg($msg, $tpl) {		$buffer['msg'] = $msg;			$this->render($tpl, $buffer); die;	}	/*	 * Assign buffer and render template with Smarty	 *	 * @param string => template/view file	 * @param string => buffer to assign [always $buffer]	 * @param string => the second parameter for smarty display function,	 * 	<br />so that Smarty will cache more files based on different variables, which is VERY useful in PRODUCTION mode !		<br />otherwise you will get the same page content if you visit the same page with different parameters.		<br />For example:		1: http://localhost/news/detail.php?id=1		1: http://localhost/news/detail.php?id=2		@return null	 */	public function render($tpl, $buffer = '', $queryString = '', $display = TRUE) {		require CONFIG_PATH.'/smarty/libs/Smarty.class.php';		require CONFIG_PATH.'/Smarty_config.php';		if(defined('SITE_GROUP') && !defined('NOGROUP') && SITE_GROUP != 'wx'){			$tpl = SITE_GROUP .'/'. $tpl;		}		if(FALSE === $this->caching){			$smarty->caching = FALSE;		}		if($this->viewPath){			$smarty->template_dir = $this->viewPath;		}		// Really load config file		$config = Helper::$config;		if($config){			foreach($config as $val){				$file = CONFIG_PATH.'/'.$val.'_config.php';				if(file_exists($file)){					include $file;				}			}		}		// 1: 查询已开的分站城市 (热门城市) [仅供前台调用]		if(!defined('ADMIN_MODE')){			$buffer['openCities'] = Helper::getCities();			$article = Helper::load('article');			$menu = $article->index(1, 1, true);			$buffer['footerArticle'] = $menu;						// TKD			Helper::loadConfig('Website');			include CONFIG_PATH . '/Website_config.php';                       $region = getParam('region');            $district = getParam('district');            $groupID = getParam('groupID');            $id = getParam('id');            $param = getParam('param');            $param = substr($param,14);               $arr = explode("_",$param);              $param = $arr[0];               if($groupID){                $m_community = $this->load('GroupNew');                $community = $m_community->getCommunityName($groupID);                $community = $community.'_';            }                        if($id OR $param){                $id = !empty($param) ? $param : $id;                $m_community = $this->load('Community');                $community = $m_community->getCommunityName($id);                $buffer['communityName'] = $community;                $community = $community.'_';            }                        if($region){                $m_region = $this->load('Region');    			$regionID = $m_region->getFieldByFullPY($region);                $region = '_'.$regionID['region'];                $buffer['regionName'] = $region;    		}    		    		if($district){                $m_district = $this->load('District');      			$districtID = $m_district->getFieldByFullPY($district);                $district = '_'.$districtID['district'];    		}            			foreach($Config AS $k => $v){				$Config[$k] = str_replace("[city]", CITY, $Config[$k], $i);                $Config[$k] = str_replace("[region][district]", $region.$district, $Config[$k], $i);                 $Config[$k] = str_replace("[community]", $community, $Config[$k], $i);			}						$buffer['Config'] = $Config;		}		$smarty->assign($buffer);		$smarty->assign($Config);  // Global config file for tpl		$this->tmpPath = $template_dir;		if($display){			$smarty->display($tpl, $queryString); die;		}else{			return $smarty->fetch($tpl, $queryString, null, null, FALSE);		}	}	/**	 *	生成静态页	 * @$content  内容	 * @$tplFile  模板文件	 * @$path    静态文件保存的路径 如acticle 保存的文件路径为 /static/acticle	 * @fileName 保存的文件名称	 */	public function createStaticHtml($content, $path, $fileName){		$path = rtrim(HTML_PATH . '/' . $path, '/') . '/';		//生成静态页		file_put_contents($path.$fileName.STATIC_SUFFER, $content);	}	/**	 * jump method	 *	 * @param string $message => 跳转时显示的信息	 * @param int $status => 状态 0表示错误 1表示成功	 * @param string $jumpUrl => 要跳转的地址 默认为上一页面地址	 * @param int $wait => 等待时间	 */	protected function jump($message, $status = 1, $jumpUrl, $wait = 0) {		$time = $wait*1000;		$buffer['waitSecond'] = $time;		$buffer['second'] = $wait;		$buffer['jumpUrl'] = $jumpUrl;		$buffer['message'] = $message;		$buffer['PageTitle'] = '页面提示';		if($status) {			if(!$wait) {				$buffer['waitSecond'] = 1000;// 成功操作后默认停留1秒				$buffer['second'] = 1;			}		} else {			if(!$wait) {				$buffer['waitSecond'] = 3000;// 成功操作后默认停留3秒				$buffer['second'] = 3;			}		}		if(!$jumpUrl) {			$buffer['jumpUrl'] = $jumpUrl = 'javascript:history.back(-1)';// 默认发生错误的话自动返回上页		}		//做成直接alert和直接跳转的形式		jsAlert($message);		jsRedirect($jumpUrl);		// $this->render('tips.html', $buffer); die;	}	/**	 * 错误时的跳转方法	 *	 * @param string $message => 跳转时显示的信息	 * @param string $jumpUrl => 要跳转的地址 默认为上一页面地址	 * @param int $wait => 等待时间 默认为3秒	 */	public function error($message, $jumpUrl = '', $wait = 3) {		$this->jump($message, 0, $jumpUrl, $wait);	}	/**	 * 成功时的跳转方法	 *	 * @param string $message => 跳转时显示的信息	 * @param string $jumpUrl => 要跳转的地址 默认为上一页面地址	 * @param int $wait => 等待时间 默认为1秒	 */	protected function success($message, $jumpUrl = '', $wait = 1) {		$this->jump($message, 1, $jumpUrl, $wait);	}	// Call session_start() if no session_id()	protected function sessionStart() {		if(!session_id()) {			//2014-5-21 change by 小皓 让uploadify支持session			$session_name = session_name();			if (isset($_POST[$session_name])) {				session_id($_POST[$session_name]);			}			session_start();		}				// Nic + 2014-5-17		if($_SESSION['user']['id']){			define('USER_ID', $_SESSION['user']['id']);		}	}}